name: 🛡️ Security-First CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'

# Security-focused permissions
permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # Phase 1: Security Validation
  security-audit:
    name: 🔍 Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: 📥 Checkout Code
      uses: actions/checkout@v4
      with:
        # Full history for better security analysis
        fetch-depth: 0

    - name: 🔧 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: 📦 Install Dependencies
      run: |
        npm ci --ignore-scripts
        # Audit installation process
        echo "Dependencies installed successfully"

    - name: 🚨 Dependency Vulnerability Scan
      run: |
        echo "🔍 Scanning for vulnerable dependencies..."
        npm audit --audit-level=moderate
        npm audit --json > audit-results.json || true
        
        # Count vulnerabilities
        CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-results.json)
        HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-results.json)
        
        echo "Critical vulnerabilities: $CRITICAL"
        echo "High vulnerabilities: $HIGH"
        
        # Fail on critical vulnerabilities
        if [ "$CRITICAL" -gt 0 ]; then
          echo "❌ Critical vulnerabilities found - failing build"
          exit 1
        fi
        
        # Warn on high vulnerabilities
        if [ "$HIGH" -gt 0 ]; then
          echo "⚠️ High vulnerabilities found - review required"
        fi

    - name: 🔒 License Compliance Check
      run: |
        echo "🔍 Checking license compliance..."
        npx license-checker --summary --excludePrivatePackages
        
        # Check for problematic licenses
        npx license-checker --json --excludePrivatePackages > licenses.json
        
        # Fail on GPL licenses (incompatible with commercial use)
        GPL_COUNT=$(jq -r 'to_entries[] | select(.value.licenses | type == "string" and (contains("GPL") or contains("AGPL"))) | .key' licenses.json | wc -l)
        
        if [ "$GPL_COUNT" -gt 0 ]; then
          echo "❌ GPL licensed dependencies found - review required"
          jq -r 'to_entries[] | select(.value.licenses | type == "string" and (contains("GPL") or contains("AGPL"))) | "\(.key): \(.value.licenses)"' licenses.json
          # Don't fail build, just warn for now
        fi

    - name: 🛡️ Security Linting
      run: |
        echo "🔍 Running security-focused ESLint rules..."
        npx eslint . --ext .js,.jsx,.ts,.tsx --config .eslintrc.json --format json > eslint-results.json || true
        
        # Count security-related errors
        SECURITY_ERRORS=$(jq '[.[] | .messages[] | select(.ruleId | contains("security") or contains("no-eval") or contains("no-implied-eval"))] | length' eslint-results.json)
        
        echo "Security lint errors: $SECURITY_ERRORS"
        
        if [ "$SECURITY_ERRORS" -gt 0 ]; then
          echo "❌ Security linting errors found"
          jq -r '.[] | .messages[] | select(.ruleId | contains("security") or contains("no-eval") or contains("no-implied-eval")) | "\(.ruleId): \(.message) at \(.line):\(.column)"' eslint-results.json
          exit 1
        fi

    - name: 🔍 Secret Scanning
      run: |
        echo "🔍 Scanning for accidentally committed secrets..."
        
        # Check for common secret patterns
        git log --all --full-history -- . | grep -E "(password|secret|key|token|api.key|private)" && echo "⚠️ Potential secrets found in git history" || echo "✅ No secrets detected in git history"
        
        # Check current files for secret patterns (basic check)
        find . -type f -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" -o -name "*.json" | xargs grep -l "sk_live\|pk_live\|api[_-]?key\|secret" && echo "⚠️ Potential secrets in source files" || echo "✅ No hardcoded secrets detected"

  # Phase 2: Application Security Testing
  security-testing:
    name: 🧪 Security Testing
    runs-on: ubuntu-latest
    needs: security-audit
    timeout-minutes: 20

    steps:
    - name: 📥 Checkout Code
      uses: actions/checkout@v4

    - name: 🔧 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: 📦 Install Dependencies
      run: npm ci

    - name: 🧪 Security Test Suite
      run: |
        echo "🧪 Running security-focused tests..."
        npm run test:security || exit 1
        echo "✅ All security tests passed"

    - name: 📊 Test Coverage Analysis
      run: |
        echo "📊 Analyzing test coverage for security-critical paths..."
        npm run test:coverage -- --json > coverage.json
        
        # Check coverage for security-critical files
        SECURITY_COVERAGE=$(jq '.coverageMap | to_entries[] | select(.key | contains("security") or contains("validation") or contains("auth")) | .value.s | add / length * 100' coverage.json 2>/dev/null || echo "0")
        
        echo "Security-critical code coverage: ${SECURITY_COVERAGE}%"
        
        if (( $(echo "$SECURITY_COVERAGE < 80" | bc -l) )); then
          echo "⚠️ Low coverage on security-critical code"
        fi

    - name: 🔧 Build Application
      run: |
        echo "🔧 Building application with security checks..."
        npm run build
        echo "✅ Build completed successfully"
      env:
        NODE_ENV: production
        NEXT_PUBLIC_SITE_URL: https://security-portfolio-test.vercel.app

    - name: 🛡️ Post-Build Security Validation
      run: |
        echo "🛡️ Validating build security..."
        
        # Check for client-side secrets in build output
        find .next -name "*.js" -exec grep -l "sk_live\|pk_live\|secret\|private" {} \; && echo "❌ Secrets found in build output" && exit 1 || echo "✅ No secrets in build output"
        
        # Verify security headers in build config
        if [ -f ".next/server/app/api/security-posture/route.js" ]; then
          echo "✅ Security posture API built successfully"
        else
          echo "❌ Security posture API missing from build"
          exit 1
        fi

  # Phase 3: Infrastructure Security
  infrastructure-security:
    name: 🏗️ Infrastructure Security
    runs-on: ubuntu-latest
    needs: security-testing
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: 📥 Checkout Code
      uses: actions/checkout@v4

    - name: 🔍 Configuration Security Scan
      run: |
        echo "🔍 Scanning configuration files for security issues..."
        
        # Check next.config.js for security headers
        if grep -q "Content-Security-Policy" next.config.js; then
          echo "✅ CSP configuration found"
        else
          echo "❌ CSP configuration missing"
          exit 1
        fi
        
        if grep -q "Strict-Transport-Security" next.config.js; then
          echo "✅ HSTS configuration found"
        else
          echo "❌ HSTS configuration missing"
          exit 1
        fi

    - name: 🔐 Environment Security Check
      run: |
        echo "🔐 Validating environment configuration..."
        
        # Check .env.example exists and has security variables
        if [ -f ".env.example" ]; then
          echo "✅ Environment template found"
          
          # Check for security-related environment variables
          if grep -q "UPSTASH_REDIS" .env.example; then
            echo "✅ Rate limiting configuration documented"
          fi
          
          if grep -q "CSP_REPORT_URI" .env.example; then
            echo "✅ CSP reporting configuration documented"
          fi
        else
          echo "❌ Environment template missing"
          exit 1
        fi

  # Phase 4: Deployment Security
  deploy-security:
    name: 🚀 Deployment Security
    runs-on: ubuntu-latest
    needs: [security-audit, security-testing, infrastructure-security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}

    steps:
    - name: 📥 Checkout Code
      uses: actions/checkout@v4

    - name: 🚀 Deploy to Vercel
      id: deploy
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
        vercel-org-id: ${{ secrets.ORG_ID }}
        vercel-project-id: ${{ secrets.PROJECT_ID }}
        working-directory: ./
        vercel-args: '--prod'

    - name: 🔍 Post-Deployment Security Validation
      run: |
        echo "🔍 Validating deployed application security..."
        
        DEPLOYED_URL="${{ steps.deploy.outputs.url }}"
        echo "Testing URL: $DEPLOYED_URL"
        
        # Wait for deployment to be ready
        sleep 30
        
        # Test security headers
        echo "Testing security headers..."
        HEADERS_RESPONSE=$(curl -s -I "$DEPLOYED_URL" || echo "CURL_FAILED")
        
        if echo "$HEADERS_RESPONSE" | grep -q "content-security-policy"; then
          echo "✅ CSP header present"
        else
          echo "❌ CSP header missing"
        fi
        
        if echo "$HEADERS_RESPONSE" | grep -q "strict-transport-security"; then
          echo "✅ HSTS header present"
        else
          echo "❌ HSTS header missing"
        fi
        
        # Test security posture API
        echo "Testing security posture API..."
        POSTURE_RESPONSE=$(curl -s "$DEPLOYED_URL/api/security-posture" | jq -r '.score // "ERROR"')
        
        if [ "$POSTURE_RESPONSE" != "ERROR" ] && [ "$POSTURE_RESPONSE" -ge 90 ]; then
          echo "✅ Security posture API working (Score: $POSTURE_RESPONSE)"
        else
          echo "❌ Security posture API failed or score too low"
        fi

    - name: 📊 External Security Scan
      if: success()
      run: |
        echo "📊 Triggering external security scans..."
        
        DEPLOYED_URL="${{ steps.deploy.outputs.url }}"
        
        # Note: In a real deployment, you might integrate with:
        # - Mozilla Observatory API
        # - Security Headers API  
        # - SSL Labs API
        # - Custom security scanning tools
        
        echo "🔗 Manual verification URLs:"
        echo "Mozilla Observatory: https://observatory.mozilla.org/analyze/${DEPLOYED_URL#https://}"
        echo "Security Headers: https://securityheaders.com/?q=$DEPLOYED_URL"
        echo "SSL Labs: https://www.ssllabs.com/ssltest/analyze.html?d=${DEPLOYED_URL#https://}"

  # Phase 5: Security Monitoring Setup
  monitoring-setup:
    name: 📊 Security Monitoring
    runs-on: ubuntu-latest
    needs: deploy-security
    if: success()

    steps:
    - name: 🔔 Security Alert Setup
      run: |
        echo "🔔 Security monitoring is active"
        echo "- CSP violations will be reported to: /api/security/csp-report"
        echo "- Security posture monitored at: /security-posture"
        echo "- Rate limiting active with distributed Redis backend"
        echo "- Dependency vulnerabilities checked daily"
        
        # In a real setup, you might:
        # - Configure monitoring dashboards
        # - Set up alerting rules
        # - Initialize security incident response
        # - Schedule regular security scans
