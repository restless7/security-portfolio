name: ğŸ” Security Health Check (Every 6 Hours)

on:
  schedule:
    # Run every 6 hours at minutes 0 (00:00, 06:00, 12:00, 18:00 UTC)
    - cron: '0 */6 * * *'
  
  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual trigger'
        required: false
        default: 'Manual security check'

jobs:
  security-health-check:
    name: ğŸ›¡ï¸ Execute Security Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ Log Workflow Start
        run: |
          echo "ğŸš€ Starting security health check..."
          echo "ğŸ“… Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "ğŸ”„ Trigger: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ğŸ“ Reason: ${{ github.event.inputs.reason }}"
          fi
      
      - name: ğŸ” Verify Environment
        run: |
          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "âŒ CRON_SECRET is not set in repository secrets"
            echo "ğŸ“– Please add CRON_SECRET in Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          fi
          
          if [ -z "${{ secrets.VERCEL_DEPLOYMENT_URL }}" ]; then
            echo "âš ï¸ VERCEL_DEPLOYMENT_URL not set, using default"
            echo "ğŸ’¡ Set VERCEL_DEPLOYMENT_URL in repository secrets for production"
          fi
          
          echo "âœ… Environment validation passed"
      
      - name: ğŸ¥ Execute Health Check
        run: |
          DEPLOYMENT_URL="${{ secrets.VERCEL_DEPLOYMENT_URL }}"
          if [ -z "$DEPLOYMENT_URL" ]; then
            echo "âš ï¸ Using fallback URL - please set VERCEL_DEPLOYMENT_URL secret"
            DEPLOYMENT_URL="https://your-portfolio.vercel.app"
          fi
          
          echo "ğŸŒ Target URL: $DEPLOYMENT_URL"
          echo "ğŸ” Executing security health check..."
          
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}\nTOTAL_TIME:%{time_total}" \
            -H "Authorization: ${{ secrets.CRON_SECRET }}" \
            -H "User-Agent: GitHub-Actions-Cron/1.0 (Security-Portfolio)" \
            -H "Accept: application/json" \
            -L \
            "${DEPLOYMENT_URL%/}/api/cron" || echo "CURL_FAILED")
          
          # Extract HTTP code and response time
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          TOTAL_TIME=$(echo "$RESPONSE" | grep "TOTAL_TIME:" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/,$d')
          
          echo "ğŸ“Š Response Details:"
          echo "   Status Code: $HTTP_CODE"
          echo "   Response Time: ${TOTAL_TIME}s"
          echo "   Response Body: $BODY"
          
          # Check if the request was successful
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Security health check completed successfully!"
            
            # Parse and display task results if available
            if echo "$BODY" | grep -q '"ok":true'; then
              echo "ğŸ¯ All scheduled tasks completed successfully"
              
              # Extract task statuses if present
              HEALTH_STATUS=$(echo "$BODY" | grep -o '"healthCheck":{[^}]*}' | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
              POSTURE_STATUS=$(echo "$BODY" | grep -o '"securityPosture":{[^}]*}' | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
              
              if [ ! -z "$HEALTH_STATUS" ]; then
                echo "ğŸ¥ Health Check Status: $HEALTH_STATUS"
              fi
              if [ ! -z "$POSTURE_STATUS" ]; then
                echo "ğŸ›¡ï¸ Security Posture Status: $POSTURE_STATUS"
              fi
            fi
          elif [ "$HTTP_CODE" = "401" ] || [ "$HTTP_CODE" = "403" ]; then
            echo "âŒ Authentication failed! Check CRON_SECRET configuration."
            echo "ğŸ”§ Troubleshooting:"
            echo "   1. Verify CRON_SECRET is set in GitHub repository secrets"
            echo "   2. Verify CRON_SECRET is set in Vercel environment variables"
            echo "   3. Ensure both secrets match exactly"
            exit 1
          elif [ "$HTTP_CODE" = "404" ]; then
            echo "âŒ Cron endpoint not found! Check deployment URL."
            echo "ğŸ”§ Troubleshooting:"
            echo "   1. Verify VERCEL_DEPLOYMENT_URL is correct"
            echo "   2. Ensure /api/cron route is deployed"
            echo "   3. Check Vercel deployment logs"
            exit 1
          elif [ "$HTTP_CODE" = "500" ]; then
            echo "âš ï¸ Server error occurred during health check"
            echo "ğŸ“‹ Response: $BODY"
            echo "ğŸ’¡ This may indicate an issue with the health check tasks"
            # Don't exit with error for 500s - log and continue
          else
            echo "âš ï¸ Unexpected response code: $HTTP_CODE"
            echo "ğŸ“‹ Response: $BODY"
            if [ "$RESPONSE" = "CURL_FAILED" ]; then
              echo "âŒ Network error - could not reach deployment"
              exit 1
            fi
          fi
      
      - name: ğŸ“Š Log Completion
        run: |
          echo "ğŸ Security health check workflow completed"
          echo "ğŸ“… Finished at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "â° Next scheduled run: $(date -u -d '+6 hours' +"%Y-%m-%d %H:%M:%S UTC")"
      
      - name: ğŸš¨ Notify on Failure
        if: failure()
        run: |
          echo "ğŸš¨ Security health check workflow failed!"
          echo "ğŸ“§ Consider setting up notifications for critical security monitoring"
          echo "ğŸ” Check the workflow logs for detailed error information"
          echo "âš™ï¸ Verify all secrets and environment variables are configured correctly"
